<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expo Construcción - NoCookie Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Teko:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; overflow: hidden; background: #020205; font-family: 'Rajdhani', sans-serif; }
        
        /* MENU */
        #blocker {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #001a33 0%, #000 100%);
            z-index: 99; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #00d2ff;
        }
        h1 { font-family: 'Teko', sans-serif; font-size: 6vw; margin: 0; color: #fff; text-shadow: 0 0 30px #00d2ff; text-transform: uppercase; }
        .instructions {
            border: 1px solid #00d2ff; padding: 20px; background: rgba(0,0,0,0.6); 
            margin-top: 20px; border-radius: 8px; text-align: center; color: white;
        }
        .key { border: 1px solid white; padding: 3px 8px; border-radius: 4px; font-weight: bold; color: #00d2ff; }
        #start-btn {
            margin-top: 30px; padding: 15px 50px; font-size: 1.5rem; font-family: 'Teko', sans-serif;
            background: transparent; border: 2px solid #00d2ff; color: #00d2ff; cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        #start-btn:hover { background: #00d2ff; color: #000; box-shadow: 0 0 40px #00d2ff; }

        /* HUD */
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 8px; height: 8px;
            background: white; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10; opacity: 0.8;
        }
        #interaction-msg {
            position: absolute; bottom: 20%; width: 100%; text-align: center;
            color: #fff; font-size: 1.5rem; font-weight: bold; display: none; text-shadow: 0 2px 4px black;
            font-family: 'Teko'; letter-spacing: 2px;
        }

        /* MODAL */
        #stand-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100; justify-content: center; align-items: center;
        }
        .modal-card {
            width: 90%; max-width: 1000px; height: 70vh; background: #0b1116; border: 2px solid #00d2ff;
            display: flex; box-shadow: 0 0 50px rgba(0, 210, 255, 0.2);
        }
        .vid-container { flex: 2; background: black; position: relative; display:flex; align-items:center; justify-content:center; }
        .vid-container iframe { width: 100%; height: 100%; border: none; }
        
        .info-container { flex: 1; padding: 30px; color: #ccc; position: relative; display: flex; flex-direction: column; justify-content: center; border-left: 1px solid #333; }
        .info-container h2 { color: #00d2ff; font-family: 'Teko'; font-size: 3rem; margin: 0; line-height: 1; text-transform: uppercase;}
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 2rem; color: white; background: none; border: none; cursor: pointer; }
        .btn-link { display: block; padding: 15px; text-align: center; font-weight: bold; text-decoration: none; margin-top: 15px; font-family: 'Teko'; font-size: 1.4rem; transition: 0.3s; }
        .btn-buy { background: #00d2ff; color: black; }
        .btn-buy:hover { background: #fff; box-shadow: 0 0 20px #fff; }
        .btn-doc { border: 1px solid #555; color: #aaa; }
        .btn-doc:hover { border-color: #fff; color: #fff; }
    </style>
</head>
<body>

    <div id="blocker">
        <h1>EXPO CONSTRUCCIÓN</h1>
        <div class="instructions">
            <p><span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span> para MOVERSE</p>
            <p>MOUSE para MIRAR</p>
            <p>CLIC para INTERACTUAR</p>
        </div>
        <button id="start-btn">INGRESAR</button>
    </div>

    <div id="crosshair"></div>
    <div id="interaction-msg">CLIC PARA VER DETALLES</div>

    <div id="stand-modal">
        <div class="modal-card">
            <div class="vid-container" id="video-wrapper"></div>
            <div class="info-container">
                <button class="close-btn" onclick="closeModal()">×</button>
                <h2 id="m-title">TITULO</h2>
                <p>Información exclusiva y ofertas limitadas.</p>
                <a id="m-buy" href="#" class="btn-link btn-buy" target="_blank">IR AL SITIO</a>
                <a id="m-doc" href="#" class="btn-link btn-doc" target="_blank">BROCHURE</a>
            </div>
        </div>
    </div>

    <script>
        // ======================================================================
        //  SOLUCIÓN VIDEO: USAR 'youtube-nocookie.com'
        // ======================================================================
        
        // He cambiado el dominio a youtube-nocookie.com. Esto suele arreglar el error 153
        // en entornos embebidos estrictos.
        
        const IFRAME_1 = `<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/mZ_uPr7rHT4?si=s-docLxR3NVd3Q5T" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
        const IFRAME_2 = `<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/NbFwmRgeRaE?si=TNLoQdf-OTvXNuOY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
        const IFRAME_3 = `<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/827OMBNYRKI?si=mCi4CvUeRVnzuqx9" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;
        const IFRAME_4 = `<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/Q-pgvolirH8?si=Gu8FC9Xgymi-65IE" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;

        const DATA = [
            // --- IZQUIERDA (5 Stands) ---
            // Fila Trasera (3)
            { t: "BIM MANAGER", pos: "left-back", iframeCode: IFRAME_1 },
            { t: "SEGURIDAD",   pos: "left-back", iframeCode: IFRAME_2 },
            { t: "RESIDENCIA",  pos: "left-back", iframeCode: IFRAME_3 },
            // Fila Delantera (2 - Huecos)
            { t: "TOPOGRAFÍA",  pos: "left-front", iframeCode: IFRAME_4 },
            { t: "MAQUINARIA",  pos: "left-front", iframeCode: IFRAME_1 }, 

            // --- DERECHA (5 Stands) ---
            // Fila Trasera (3)
            { t: "PRECIOS UNIT.", pos: "right-back", iframeCode: IFRAME_2 }, 
            { t: "LEAN CONST.",   pos: "right-back", iframeCode: IFRAME_3 }, 
            { t: "ESTRUCTURAS",   pos: "right-back", iframeCode: IFRAME_4 }, 
            // Fila Delantera (2)
            { t: "INSTALACIONES", pos: "right-front", iframeCode: IFRAME_1 }, 
            { t: "INTERVENTORÍA", pos: "right-front", iframeCode: IFRAME_2 }, 

            // --- PRINCIPAL (Fondo Centro) ---
            { t: "MASTER GERENCIA", pos: "center", iframeCode: IFRAME_3 },

            // --- SALIDAS (Atrás - ACERCADAS) ---
            { t: "SALIDA: LANDING", pos: "exit-center", link: "https://google.com" }, 
            { t: "OTRA PAGINA 1",   pos: "exit-left", link: "#" }, 
            { t: "OTRA PAGINA 2",   pos: "exit-right", link: "#" } 
        ];

        // POINTER LOCK CONTROLS
        THREE.PointerLockControls=function(t,e){if(void 0===e&&(e=document.body),this.domElement=e,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1.0,!(t instanceof THREE.Camera))throw new Error("THREE.PointerLockControls: First parameter must be a camera.");var n=this,o={type:"change"},r={type:"lock"},i={type:"unlock"},c=new THREE.Euler(0,0,0,"YXZ"),s=Math.PI/2,a=new THREE.Vector3;function l(e){if(!1!==n.isLocked){var r=e.movementX||e.mozMovementX||e.webkitMovementX||0,i=e.movementY||e.mozMovementY||e.webkitMovementY||0;c.setFromQuaternion(t.quaternion),c.y-=r*.002*n.pointerSpeed,c.x-=i*.002*n.pointerSpeed,c.x=Math.max(s-n.maxPolarAngle,Math.min(s-n.minPolarAngle,c.x)),t.quaternion.setFromEuler(c),n.dispatchEvent(o)}}function u(){n.domElement.ownerDocument.pointerLockElement===n.domElement?(n.dispatchEvent(r),n.isLocked=!0):(n.dispatchEvent(i),n.isLocked=!1)}this.connect=function(){n.domElement.ownerDocument.addEventListener("mousemove",l,!1),n.domElement.ownerDocument.addEventListener("pointerlockchange",u,!1)},this.disconnect=function(){n.domElement.ownerDocument.removeEventListener("mousemove",l,!1),n.domElement.ownerDocument.removeEventListener("pointerlockchange",u,!1)},this.dispose=function(){this.disconnect()},this.getObject=function(){return t},this.getDirection=function(){var e=new THREE.Vector3(0,0,-1);return function(n){return n.copy(e).applyQuaternion(t.quaternion)}}(),this.moveForward=function(e){a.setFromMatrixColumn(t.matrix,0),a.crossVectors(t.up,a),t.position.addScaledVector(a,e)},this.moveRight=function(e){a.setFromMatrixColumn(t.matrix,0),t.position.addScaledVector(a,e)},this.lock=function(){this.domElement.requestPointerLock()},this.unlock=function(){n.domElement.ownerDocument.exitPointerLock()},this.connect()};THREE.PointerLockControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.PointerLockControls.prototype.constructor=THREE.PointerLockControls;

        let camera, scene, renderer, controls, raycaster;
        let moveF = false, moveB = false, moveL = false, moveR = false;
        let prevTime = performance.now();
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        const interactables = []; 
        const screensToRotate = [];
        let hovered = null;
        const textureLoader = new THREE.TextureLoader();

        // Contadores para layout
        let leftBackCount = 0, leftFrontCount = 0;
        let rightBackCount = 0, rightFrontCount = 0;

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a1a); 
            scene.fog = new THREE.Fog(0x0a0a1a, 20, 100);

            // CÁMARA: Z=35
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.7, 35);

            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            
            const centerL = new THREE.PointLight(0x00d2ff, 1, 60);
            centerL.position.set(0, 15, -20);
            scene.add(centerL);

            const exitL = new THREE.PointLight(0x0055ff, 0.8, 40);
            exitL.position.set(0, 10, 45);
            scene.add(exitL);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new THREE.PointerLockControls(camera, document.body);
            document.getElementById('start-btn').addEventListener('click', () => controls.lock());
            controls.addEventListener('lock', () => document.getElementById('blocker').style.display = 'none');
            controls.addEventListener('unlock', () => {
                if(document.getElementById('stand-modal').style.display !== 'flex') document.getElementById('blocker').style.display = 'flex';
            });

            document.addEventListener('keydown', (e) => onKey(e, true));
            document.addEventListener('keyup', (e) => onKey(e, false));
            document.addEventListener('click', onClick);
            window.addEventListener('resize', onResize);
            
            raycaster = new THREE.Raycaster();

            buildEnvironment();
            buildLayout();
        }

        function onKey(e, v) {
            switch(e.code) {
                case 'KeyW': moveF = v; break;
                case 'KeyS': moveB = v; break;
                case 'KeyA': moveL = v; break;
                case 'KeyD': moveR = v; break;
            }
        }

        function buildEnvironment() {
            const c = document.createElement('canvas'); c.width=512; c.height=512;
            const ctx = c.getContext('2d');
            ctx.fillStyle='#050510'; ctx.fillRect(0,0,512,512);
            ctx.strokeStyle='#00d2ff'; ctx.lineWidth=3; ctx.beginPath();
            for(let i=0; i<=512; i+=128) { ctx.moveTo(i,0); ctx.lineTo(i,512); ctx.moveTo(0,i); ctx.lineTo(512,i); } ctx.stroke();
            ctx.strokeStyle='#003355'; ctx.lineWidth=1; ctx.beginPath();
            for(let i=0; i<=512; i+=32) { ctx.moveTo(i,0); ctx.lineTo(i,512); ctx.moveTo(0,i); ctx.lineTo(512,i); } ctx.stroke();
            
            const tex = new THREE.CanvasTexture(c);
            tex.wrapS = THREE.RepeatWrapping; tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(40,40);
            const plane = new THREE.Mesh(new THREE.PlaneGeometry(400,400), new THREE.MeshStandardMaterial({ map: tex, roughness:0.4, metalness:0.6 }));
            plane.rotation.x = -Math.PI/2;
            scene.add(plane);

            const skyGeo = new THREE.SphereGeometry(200, 64, 64);
            const skyTex = textureLoader.load('https://images.unsplash.com/photo-1570284613060-766c33850e00?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Nnx8Y2llbG8lMjBlc3RyZWxsYWRvfGVufDB8fDB8fHww');
            const skyMat = new THREE.MeshBasicMaterial({ map: skyTex, side: THREE.BackSide, fog: false });
            const sky = new THREE.Mesh(skyGeo, skyMat);
            scene.add(sky);
        }

        function createBannerTex(text, color, bgColor) {
            const cvs = document.createElement('canvas'); cvs.width=512; cvs.height=256;
            const ctx = cvs.getContext('2d');
            ctx.fillStyle = bgColor || 'rgba(0,5,15,0.95)'; ctx.fillRect(0,0,512,256);
            ctx.shadowBlur = 20; ctx.shadowColor = color;
            ctx.strokeStyle = color; ctx.lineWidth=10; ctx.strokeRect(10,10,492,236);
            ctx.shadowBlur = 0;
            ctx.fillStyle = 'white'; ctx.font = 'bold 48px Arial'; 
            ctx.textAlign = 'center'; ctx.textBaseline='middle';
            ctx.fillText(text, 256, 128);
            return new THREE.CanvasTexture(cvs);
        }

        function buildLayout() {
            DATA.forEach(d => {
                const group = new THREE.Group();
                let x=0, z=0, w=6, h=3.5, color='#00d2ff', rot=0;
                let bgColor = null;

                // LAYOUT ZIG-ZAG (3 Atrás, 2 Adelante)
                
                if(d.pos === 'left-back') {
                    const idx = leftBackCount++; 
                    z = 10 - (idx * 12); 
                    x = -22; 
                    rot = Math.PI / 4;
                } 
                else if (d.pos === 'left-front') {
                    const idx = leftFrontCount++;
                    z = 4 - (idx * 12); 
                    x = -12; 
                    rot = Math.PI / 6;
                }
                else if(d.pos === 'right-back') {
                    const idx = rightBackCount++;
                    z = 10 - (idx * 12);
                    x = 22;
                    rot = -Math.PI / 4;
                }
                else if(d.pos === 'right-front') {
                    const idx = rightFrontCount++;
                    z = 4 - (idx * 12);
                    x = 12;
                    rot = -Math.PI / 6;
                }
                else if(d.pos === 'center') {
                    x = 0; z = -40; w=16; h=7; color='#ffaa00'; rot = 0;
                }
                else if(d.pos.includes('exit')) {
                    // SALIDAS APEGADAS (DE 45 A 38)
                    z = 38; h=4; color='#0055ff'; rot = Math.PI; bgColor='rgba(0,20,100,0.9)';
                    if(d.pos === 'exit-center') { x=0; w=10; }
                    if(d.pos === 'exit-left') { x=-12; w=6; }
                    if(d.pos === 'exit-right') { x=12; w=6; }
                }

                group.position.set(x, 0, z);
                group.rotation.y = rot;

                if(!d.pos.includes('exit')) {
                    const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, h/2, 8), new THREE.MeshBasicMaterial({color:0x222}));
                    pole.position.y = h/4;
                    group.add(pole);
                }

                const bannerTex = createBannerTex(d.t, color, bgColor);
                const bannerMat = new THREE.MeshBasicMaterial({ map: bannerTex, side: THREE.DoubleSide });
                const banner = new THREE.Mesh(new THREE.PlaneGeometry(w, h), bannerMat);
                banner.position.y = h; 
                
                banner.userData = { data: d };
                interactables.push(banner);
                
                if(!d.pos.includes('exit')) {
                    screensToRotate.push(banner);
                }

                group.add(banner);
                
                if(!d.pos.includes('exit')) {
                    const light = new THREE.PointLight(color, 0.5, 8);
                    light.position.set(0, h, 2);
                    group.add(light);
                }

                scene.add(group);
            });
        }

        function onClick() {
            if(controls.isLocked && hovered) {
                const d = hovered.userData.data;
                if(d.pos.includes('exit')) {
                    window.open(d.link, '_blank');
                } else {
                    openModal(d);
                    controls.unlock();
                }
            } else if(!controls.isLocked && document.getElementById('stand-modal').style.display !== 'flex') {
                controls.lock();
            }
        }

        function openModal(d) {
            document.getElementById('m-title').innerText = d.t;
            document.getElementById('m-buy').href = d.buy || "#";
            
            // INYECCIÓN DIRECTA CON NO-COOKIE
            const wrapper = document.getElementById('video-wrapper');
            wrapper.innerHTML = d.iframeCode;
            
            document.getElementById('stand-modal').style.display = 'flex';
        }

        window.closeModal = function() {
            document.getElementById('stand-modal').style.display = 'none';
            document.getElementById('video-wrapper').innerHTML = ''; // Limpiar y detener video
            controls.lock();
        }

        function onResize() {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();

            const target = camera.position.clone();
            target.y = 3.5; 
            screensToRotate.forEach(obj => {
                obj.lookAt(target); 
            });
            
            if(controls.isLocked) {
                raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
                const intersects = raycaster.intersectObjects(interactables);
                const msg = document.getElementById('interaction-msg');
                const ch = document.getElementById('crosshair');

                if(intersects.length > 0 && intersects[0].distance < 25) {
                    hovered = intersects[0].object;
                    const d = hovered.userData.data;
                    msg.innerText = d.pos.includes('exit') ? "SALIR" : "VER VIDEO";
                    msg.style.display = 'block';
                    ch.style.transform = 'translate(-50%,-50%) scale(2)';
                    ch.style.backgroundColor = d.pos.includes('exit') ? '#0055ff' : '#00d2ff';
                } else {
                    hovered = null;
                    msg.style.display = 'none';
                    ch.style.transform = 'translate(-50%,-50%) scale(1)';
                    ch.style.backgroundColor = 'white';
                }

                const delta = (time - prevTime) / 1000;
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                direction.z = Number(moveF) - Number(moveB);
                direction.x = Number(moveR) - Number(moveL);
                direction.normalize();

                if (moveF || moveB) velocity.z -= direction.z * 80.0 * delta;
                if (moveL || moveR) velocity.x -= direction.x * 80.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
            }
            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>